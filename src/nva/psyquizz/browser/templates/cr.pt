<div>
  <h1>Resultate</h1>

  <form action="." tal:attributes="action view.request.url"
	tal:define="current view.stats.filters.get('criterias', {})">
    <dl tal:define="crits view.stats.criterias">
      <tal:dl tal:repeat="crit crits">
	<dt><h3 tal:content="crit" /></dt>
	<dd>
	  <div tal:repeat="opt crits[crit]"
	       style="display: inline-block; padding: 5px;">
	    <input name="criterias" type="checkbox"
		   tal:attributes="value opt.uid;
				   checked opt.uid in current" />
              <span tal:content="'%s (%s)' % (opt.name, opt.amount)" />
	  </div>
	</dd>
      </tal:dl>
    </dl>
    <input type="submit" value="filter" />
  </form>
  
  <table>
    <tr tal:repeat="data view.stats.statistics['global.averages']">
      <td tal:content="data.title"></td> 
      <td tal:content="data.average"></td> 
    </tr>
  </table>

  <form id="result" method="POST"
	tal:attributes="action view.url(context) + '/pdf'">

    <input type="hidden" value=""
	   tal:attributes="value view.stats.json_criterias" name="criterias" />
    
    <input type="hidden"
	   tal:attributes="value view.stats.statistics['total']" name="total"/>
    
    <textarea type="text" id="averages" name="averages" style="display:none">
      <tal:data
           content="view.jsonify([[res.title, '%.2f' % res.average] for res in view.stats.statistics['global.averages']])" />
    </textarea>
    
    <textarea type="text" id="chart" name="chart" style="display: none"></textarea>
    <textarea type="text" id="userschart" name="userschart" style="display: none"></textarea>
    <input type="submit" value="pdf export" />
  </form>

  <div id="container" style="min-width: 310px; max-width: 800px; height: 400px; margin: 0 auto"></div>
  <div id="container1" style="min-width: 310px; max-width: 800px; height: 400px; margin: 0 auto"></div>
  <script>
     function svgToCanvas(chart, target_id) {
        var svg = chart.getSVG();
        var canvas = document.createElement('canvas');
        canvas.width = "600";
        canvas.height = "400";
        var ctx = canvas.getContext('2d');
        var img = document.createElement("img");
        img.setAttribute("src", "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svg))));
        img.onload = function() {
          ctx.drawImage(img, 0, 0, 400, 400);
          document.getElementById(target_id).value = canvas.toDataURL("image/png");
        };
     }

    
    var myChart = Highcharts.chart('container', {
	chart: {
            type: 'bar'
	},
	title: {
            text: 'Stacked bar chart'
	},
	xAxis: {
            categories: <span tal:replace="view.stats.xAxis"/> 
	},
	yAxis: {
            min: 0,
            title: {
		text: 'Total fruit consumption'
            }
	},
	legend: {
            reversed: true
	},
	plotOptions: {
            series: {
		stacking: 'normal'
            }
	},
	series: <span tal:replace="view.stats.series"/> 
    });

    svgToCanvas(myChart, 'chart');

    var usersChart = Highcharts.chart('container1', {
	chart: {
            polar: true,
            type: 'line'
	},
	title: {
            text: 'Budget vs spending',
            x: -80
	},
	pane: {
            size: '80%'
	},
	xAxis: {
	    categories: <span tal:replace="view.stats.xAxis"/>,
            tickmarkPlacement: 'on',
            lineWidth: 0
	},
	yAxis: {
            gridLineInterpolation: 'polygon',
            lineWidth: 0,
            tickAmount: 4,
            min: 0,
            plotBands: [
		{
		    color: '#FF0000',
		    from: 0,
		    to:  3 
		},
		{
		    color: '#FFFF00',
		    from: 3,
		    to: 4 
		},
		{
		    color: '#32DD32',
            from: 4,
		    to: 6 
		},
	    ],
	},
	legend: {
            align: 'right',
            verticalAlign: 'top',
            y: 70,
            layout: 'vertical'
	},
	series: [{
            name: 'Selected criterias',
            data: <span tal:replace="view.stats.rd"/>,
            pointPlacement: 'on'
	    }
	    <tal:general condition="view.general_stats">
	      ,
	      {
            name: 'General stats',
            data: <span tal:replace="view.general_stats.rd"/>,
            pointPlacement: 'on'
	    }
	    </tal:general>
	    ]
     });
     svgToCanvas(usersChart, 'userschart');
  </script>
</div>
